<!DOCTYPE html>  <html> <head>   <title>esl.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               esl.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>esl is a client and a server library for FreeSwitch's ESL protocol
(c) 2010 Stephane Alnet
Released under the AGPL3 license</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h3>Overview</h3>

<p>esl is modelled after Node.js' own httpServer and client.
It offers two low-level ESL handlers, createClient() and
createServer(), and a higher-level CallServer class.</p>

<p>For more information about ESL consult the FreeSwitch wiki
<a href="http://wiki.freeswitch.org/wiki/Event_Socket">Event Socket</a></p>

<p>Typically a client would be used to trigger calls asynchronously
(for example in a click-to-dial application); this mode of operation is
called "inbound" (to FreeSwitch) in the FreeSwitch documentation.</p>

<p>A server will handle calls sent to it using the "socket" diaplan
application (called "outbound" mode in the FreeSwitch documentation).
The server is available at a pre-defined port which
the socket application will specify. See
<a href="http://wiki.freeswitch.org/wiki/Event_Socket_Outbound">Event Socket Outbound</a></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h3>Usage</h3>

<pre><code>esl = require 'esl'
</code></pre>

<p>(The library is a plain Node.js module so you can also call
it from Javascript. All examples are given using CoffeeScript
for simplicity.)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">net         = </span><span class="nx">require</span> <span class="s1">&#39;net&#39;</span>
<span class="nv">querystring = </span><span class="nx">require</span> <span class="s1">&#39;querystring&#39;</span>
<span class="nv">util        = </span><span class="nx">require</span> <span class="s1">&#39;util&#39;</span>
<span class="nv">assert      = </span><span class="nx">require</span> <span class="s1">&#39;assert&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>If you ever need to debug esl, set</p>

<pre><code>esl.debug = true
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.debug = </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h3>Client Example</h3>

<p>The following code does the equivalent of "fs_cli -x".</p>

<pre><code>esl = require 'esl'

# Open connection, send arbitrary API command, disconnect.
fs_command = (cmd,cb) -&gt;
  client = esl.createClient()
  client.on 'esl_auth_request', (req,res) -&gt;
    res.auth 'ClueCon', (req,res) -&gt;
      res.api cmd, (req,res) -&gt;
        res.exit -&gt;
          client.end()
  if cb?
    client.on 'close', cb
  client.connect(8021, '127.0.0.1')

# Example
fs_command "reloadxml"
</code></pre>

<p>Note: Use</p>

<pre><code>res.event_json 'HEARTBEAT'
</code></pre>

<p>to start receiving event notifications.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h3>CallServer Example</h3>

<pre><code>server = esl.createCallServer()

server.on 'CONNECT', (req,res) -&gt;
  # Start processing the call
  # Channel data is available as req.channel_data
  # Channel UUID is available as req.unique_id
  # For example:
  uri = req.channel_data.variable_sip_req_uri

# Other FreeSwitch channel events are available as well:
server.on 'CHANNEL_ANSWER', (req,res) -&gt;
  util.log 'Call was answered'
  # You can force a disconnect (call hangup) using:
  server.force_disconnect()
server.on 'CHANNEL_HANGUP_COMPLETE', (req,res) -&gt;
  util.log 'Call was disconnected'

# Start the ESL server on port 7000.
server.listen 7000
# From the dialplan, use
#   &lt;action application="socket" data="127.0.0.1:7000 async full"/&gt;
# to hand the call over to this ESL server.
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h3>Headers parser</h3>

<p>ESL framing contains headers and a body.
The header must be decoded first to learn
the presence and length of the body.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">parse_header_text = </span><span class="nf">(header_text) -&gt;</span>
  <span class="k">if</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">debug</span>
    <span class="nx">util</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;parse_header_text(#{header_text})&quot;</span>

  <span class="nv">header_lines = </span><span class="nx">header_text</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">)</span>
  <span class="nv">headers = </span><span class="p">{}</span>
  <span class="k">for</span> <span class="nx">line</span> <span class="k">in</span> <span class="nx">header_lines</span>
    <span class="nx">do</span> <span class="nf">(line) -&gt;</span>
      <span class="p">[</span><span class="nx">name</span><span class="p">,</span><span class="nx">value</span><span class="p">]</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/: /</span><span class="p">,</span> <span class="mi">2</span>
      <span class="nx">headers</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Decode headers: in the case of the "connect" command,
the headers are all URI-encoded.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Reply-Text&#39;</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="s1">&#39;%&#39;</span>
    <span class="k">for</span> <span class="nx">name</span> <span class="k">of</span> <span class="nx">headers</span>
      <span class="nx">headers</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">querystring</span><span class="p">.</span><span class="nx">unescape</span><span class="p">(</span><span class="nx">headers</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span>

  <span class="k">return</span> <span class="nx">headers</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h3>ESL stream parser</h3>

<p>The ESL parser will parse an incoming ESL stream, whether
your code is acting as a client (connected to the FreeSwitch
ESL server) or as a server (called back by FreeSwitch due to the
"socket" application command).</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">eslParser</span>
  <span class="nv">constructor: </span><span class="nf">(@socket) -&gt;</span>
    <span class="vi">@body_length = </span><span class="mi">0</span>
    <span class="vi">@buffer = </span><span class="s2">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>When capturing the body, buffer contains the current data
(text), and body_length contains how many bytes are expected to
be read in the body.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">capture_body: </span><span class="nf">(data) -&gt;</span>
    <span class="nx">@buffer</span> <span class="o">+=</span> <span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>As long as the whole body hasn't been received, keep
adding the new data into the buffer.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@buffer</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">@body_length</span>
      <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Consume the body once it has been fully received.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">body = </span><span class="nx">@buffer</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">@body_length</span><span class="p">)</span>
    <span class="vi">@buffer = </span><span class="nx">@buffer</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">@body_length</span><span class="p">)</span>
    <span class="vi">@body_length = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Process the content</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@process</span> <span class="nx">@headers</span><span class="p">,</span> <span class="nx">body</span>
    <span class="vi">@headers = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Re-parse whatever data was left after the body was
fully consumed.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@capture_headers</span> <span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Capture headers, meaning up to the first blank line.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">capture_headers: </span><span class="nf">(data) -&gt;</span>
    <span class="nx">@buffer</span> <span class="o">+=</span> <span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Wait until we reach the end of the header.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">header_end = </span><span class="nx">@buffer</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;\n\n&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">header_end</span> <span class="o">&lt;</span> <span class="mi">0</span>
      <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Consume the headers</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">header_text = </span><span class="nx">@buffer</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">header_end</span><span class="p">)</span>
    <span class="vi">@buffer = </span><span class="nx">@buffer</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">header_end</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Parse the header lines</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@headers = </span><span class="nx">parse_header_text</span><span class="p">(</span><span class="nx">header_text</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Figure out whether a body is expected</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@headers</span><span class="p">[</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">]</span>
      <span class="vi">@body_length = </span><span class="nx">@headers</span><span class="p">[</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Parse the body (and eventually process)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@capture_body</span> <span class="s1">&#39;&#39;</span>

    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Process the (header-only) content</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@process</span> <span class="nx">@headers</span>
      <span class="vi">@headers = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Re-parse whatever data was left after these headers
were fully consumed.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@capture_headers</span> <span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Dispatch incoming data into the header or body parsers.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">on_data: </span><span class="nf">(data) -&gt;</span>
    <span class="k">if</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">debug</span>
      <span class="nx">util</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;on_data(#{data})&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Capture the body as needed</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@body_length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="k">return</span> <span class="nx">@capture_body</span> <span class="nx">data</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="nx">@capture_headers</span> <span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>For completeness provide an on_end() method.
TODO: it probably should make sure the buffer is empty?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">on_end: </span><span class="nf">() -&gt;</span>
    <span class="k">if</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">debug</span>
      <span class="nx">util</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Parser: end of stream&quot;</span>
      <span class="k">if</span> <span class="nx">@buffer</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nx">util</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Buffer is not empty, left over: #{@buffer}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h3>ESL request</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">eslRequest</span>
  <span class="nv">constructor: </span><span class="nf">(@headers,@body) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h3>ESL response and associated API</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">eslResponse</span>
  <span class="nv">constructor: </span><span class="nf">(@socket) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>A generic way of sending commands back to FreeSwitch.</p>

<pre><code> send (string,hash,function(req,res))
</code></pre>

<p>is normally not used directly.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">send: </span><span class="nf">(command,args,cb) -&gt;</span>
      <span class="k">if</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">debug</span>
        <span class="nx">util</span><span class="p">.</span><span class="nx">log</span> <span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nv">command: </span><span class="nx">command</span><span class="p">,</span> <span class="nv">args: </span><span class="nx">args</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Make sure we are the only one receiving command replies</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@socket</span><span class="p">.</span><span class="nx">removeAllListeners</span><span class="p">(</span><span class="s1">&#39;esl_command_reply&#39;</span><span class="p">)</span>
      <span class="nx">@socket</span><span class="p">.</span><span class="nx">removeAllListeners</span><span class="p">(</span><span class="s1">&#39;esl_api_response&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Register the callback for the proper event types.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">cb</span><span class="o">?</span>
        <span class="nx">@socket</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;esl_command_reply&#39;</span><span class="p">,</span> <span class="nx">cb</span>
        <span class="nx">@socket</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;esl_api_response&#39;</span><span class="p">,</span> <span class="nx">cb</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Send the command out.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@socket</span><span class="p">.</span><span class="nx">write</span> <span class="s2">&quot;#{command}\n&quot;</span>
      <span class="k">if</span> <span class="nx">args</span><span class="o">?</span>
        <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">args</span>
          <span class="nx">@socket</span><span class="p">.</span><span class="nx">write</span> <span class="s2">&quot;#{key}: #{value}\n&quot;</span>
      <span class="nx">@socket</span><span class="p">.</span><span class="nx">write</span> <span class="s2">&quot;\n&quot;</span>

  <span class="kc">on</span><span class="o">:</span> <span class="nf">(event,listener) -&gt;</span> <span class="nx">@socket</span><span class="p">.</span><span class="kc">on</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span><span class="nx">listener</span><span class="p">)</span>

  <span class="nv">end: </span><span class="nf">() -&gt;</span> <span class="nx">@socket</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <h3>Channel-level commands</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Send an API command, see <a href="http://wiki.freeswitch.org/wiki/Mod_commands">Mod commands</a></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">api: </span><span class="nf">(command,cb) -&gt;</span>
    <span class="nx">@send</span> <span class="s2">&quot;api #{command}&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cb</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Send an API command in the background.
The callback will receive the Job UUID (instead of the usual request/response pair).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">bgapi: </span><span class="nf">(command,cb) -&gt;</span>
    <span class="nx">@send</span> <span class="s2">&quot;bgapi #{command}&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nf">(req,res) -&gt;</span>
      <span class="k">if</span> <span class="nx">cb</span><span class="o">?</span>
        <span class="nv">r = </span><span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">[</span><span class="s1">&#39;Reply-Text&#39;</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/\+OK Job-UUID: (.+)$/</span>
        <span class="nx">cb</span> <span class="nx">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <h3>Event reception and filtering</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Request that the server send us events in JSON format.
(For all useful purposes this is the only supported format
in this module.)
For example:</p>

<pre><code>res.event_json 'HEARTBEAT'
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">event_json: </span><span class="nf">(events...,cb) -&gt;</span>
    <span class="nx">@send</span> <span class="s2">&quot;event json #{events.join(&#39; &#39;)}&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cb</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Remove the given event types from the events ACL.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">nixevent: </span><span class="nf">(events...,cb) -&gt;</span>
    <span class="nx">@send</span> <span class="s2">&quot;nixevent #{events.join(&#39; &#39;)}&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cb</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Remove all events types.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">noevents: </span><span class="nf">(cb) -&gt;</span>
    <span class="nx">@send</span> <span class="s2">&quot;noevents&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cb</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Generic event filtering</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">filter: </span><span class="nf">(header,value,cb) -&gt;</span>
    <span class="nx">@send</span> <span class="s2">&quot;filter #{header} #{value}&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cb</span>

  <span class="nv">filter_delete: </span><span class="nf">(header,value,cb) -&gt;</span>
    <span class="k">if</span> <span class="nx">value</span><span class="o">?</span>
      <span class="nx">@send</span> <span class="s2">&quot;filter #{header} #{value}&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cb</span>
    <span class="k">else</span>
      <span class="nx">@send</span> <span class="s2">&quot;filter #{header}&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cb</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Send an event into the FreeSwitch event queue.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">sendevent: </span><span class="nf">(event_name,args,cb) -&gt;</span>
    <span class="nx">@send</span> <span class="s2">&quot;sendevent #{event_name}&quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">cb</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Authenticate, typically used in a client:</p>

<pre><code>client = esl.createClient()
client.on 'esl_auth_request', (req,res) -&gt;
  res.auth 'ClueCon', (req,res) -&gt;
    # Start sending other commands here.
client.connect ...
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">auth: </span><span class="nf">(password,cb)       -&gt;</span> <span class="nx">@send</span> <span class="s2">&quot;auth #{password}&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cb</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>connect() and linger() are used in server mode.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">connect: </span><span class="nf">(cb)             -&gt;</span> <span class="nx">@send</span> <span class="s2">&quot;connect&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cb</span>    <span class="c1"># Outbound mode</span>

  <span class="nv">linger: </span><span class="nf">(cb)              -&gt;</span> <span class="nx">@send</span> <span class="s2">&quot;linger&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cb</span>     <span class="c1"># Outbound mode</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Send the exit command to the FreeSwitch socket.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">exit: </span><span class="nf">(cb)                -&gt;</span> <span class="nx">@send</span> <span class="s2">&quot;exit&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cb</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <h3>Event logging commands</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">log: </span><span class="nf">(level,cb) -&gt;</span>
    <span class="p">[</span><span class="nx">level</span><span class="p">,</span><span class="nx">cb</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">null</span><span class="p">,</span><span class="nx">level</span><span class="p">]</span> <span class="k">if</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">level</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
    <span class="k">if</span> <span class="nx">level</span><span class="o">?</span>
      <span class="nx">@send</span> <span class="s2">&quot;log #{level}&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cb</span>
    <span class="k">else</span>
      <span class="nx">@send</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cb</span>

  <span class="nv">nolog: </span><span class="nf">(cb)                 -&gt;</span> <span class="nx">@send</span> <span class="s2">&quot;nolog&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cb</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <h3>Message sending</h3>

<p>Send Message (to a UUID)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">sendmsg_uuid: </span><span class="nf">(uuid,command,args,cb) -&gt;</span>
    <span class="nv">options = </span><span class="nx">args</span> <span class="o">?</span> <span class="p">{}</span>
    <span class="nx">options</span><span class="p">[</span><span class="s1">&#39;call-command&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">command</span>
    <span class="nv">execute_text = </span><span class="k">if</span> <span class="nx">uuid</span><span class="o">?</span> <span class="k">then</span> <span class="s2">&quot;sendmsg #{uuid}&quot;</span> <span class="k">else</span> <span class="s1">&#39;sendmsg&#39;</span>
    <span class="nx">@send</span> <span class="nx">execute_text</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Same, assuming server/outbound ESL mode:</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">sendmsg: </span><span class="nf">(command,args,cb) -&gt;</span> <span class="nx">@sendmsg_uuid</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">command</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">cb</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <h3>Client-mode ("inbound") commands</h3>

<p>The target UUID must be specified.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Execute an application for the given UUID (in client mode)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">execute_uuid: </span><span class="nf">(uuid,app_name,app_arg,cb) -&gt;</span>
    <span class="nv">options =</span>
      <span class="s1">&#39;execute-app-name&#39;</span><span class="o">:</span> <span class="nx">app_name</span>
      <span class="s1">&#39;execute-app-arg&#39;</span><span class="o">:</span>  <span class="nx">app_arg</span>
    <span class="nx">@sendmsg_uuid</span> <span class="nx">uuid</span><span class="p">,</span> <span class="s1">&#39;execute&#39;</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Hangup a call</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">hangup_uuid: </span><span class="nf">(uuid,hangup_cause,cb) -&gt;</span>
    <span class="nx">hangup_cause</span> <span class="o">?=</span> <span class="s1">&#39;NORMAL_UNSPECIFIED&#39;</span>
    <span class="nv">options =</span>
      <span class="s1">&#39;hangup-cause&#39;</span><span class="o">:</span> <span class="nx">hangup_cause</span>
    <span class="nx">@sendmsg_uuid</span> <span class="nx">uuid</span><span class="p">,</span> <span class="s1">&#39;hangup&#39;</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span>

  <span class="nv">unicast_uuid: </span><span class="nf">(uuid,args,cb) -&gt;</span>
    <span class="nx">@sendmsg_uuid</span> <span class="nx">uuid</span><span class="p">,</span> <span class="s1">&#39;unicast&#39;</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">cb</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>nomedia_uuid: TODO</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <h3>Server-mode commands</h3>

<p>The target UUID is our (own) call UUID.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Execute an application for the current UUID (in server/outbound mode)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">execute: </span><span class="nf">(app_name,app_arg,cb)  -&gt;</span> <span class="nx">@execute_uuid</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">app_name</span><span class="p">,</span> <span class="nx">app_arg</span><span class="p">,</span> <span class="nx">cb</span>

  <span class="nv">hangup: </span><span class="nf">(hangup_cause,cb)       -&gt;</span> <span class="nx">@hangup_uuid</span>  <span class="kc">null</span><span class="p">,</span> <span class="nx">hangup_cause</span><span class="p">,</span> <span class="nx">cb</span>

  <span class="nv">unicast: </span><span class="nf">(args,cb)              -&gt;</span> <span class="nx">@unicast_uuid</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">cb</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>nomedia: TODO</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <h3>Connection Listener (socket events handler)</h3>

<p>This is modelled after Node.js' http.js</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">connectionListener= </span><span class="nf">(socket) -&gt;</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
  <span class="nv">parser = </span><span class="k">new</span> <span class="nx">eslParser</span> <span class="nx">socket</span>
  <span class="nx">socket</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nf">(data) -&gt;</span>  <span class="nx">parser</span><span class="p">.</span><span class="nx">on_data</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
  <span class="nx">socket</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span>  <span class="nf">()     -&gt;</span>  <span class="nx">parser</span><span class="p">.</span><span class="nx">on_end</span><span class="p">()</span>
  <span class="nv">parser.process = </span><span class="nf">(headers,body) -&gt;</span>
    <span class="k">if</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">debug</span>
      <span class="nx">util</span><span class="p">.</span><span class="nx">log</span> <span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nv">headers: </span><span class="nx">headers</span><span class="p">,</span> <span class="nv">body: </span><span class="nx">body</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Rewrite headers as needed to work around some weirdnesses in
the protocol;
and assign unified event IDs to the ESL Content-Types.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">switch</span> <span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span>
      <span class="k">when</span> <span class="s1">&#39;auth/request&#39;</span>
        <span class="nv">event = </span><span class="s1">&#39;esl_auth_request&#39;</span>
      <span class="k">when</span> <span class="s1">&#39;command/reply&#39;</span>
        <span class="nv">event = </span><span class="s1">&#39;esl_command_reply&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Apparently a bug in the response to "connect"</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Event-Name&#39;</span><span class="p">]</span> <span class="o">is</span> <span class="s1">&#39;CHANNEL_DATA&#39;</span>
          <span class="nv">body = </span><span class="nx">headers</span>
          <span class="nv">headers = </span><span class="p">{}</span>
          <span class="k">for</span> <span class="nx">n</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span><span class="s1">&#39;Reply-Text&#39;</span><span class="p">,</span><span class="s1">&#39;Socket-Mode&#39;</span><span class="p">,</span><span class="s1">&#39;Control&#39;</span><span class="p">]</span>
            <span class="nx">headers</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="nx">body</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span>
            <span class="k">delete</span> <span class="nx">body</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span>
      <span class="k">when</span> <span class="s1">&#39;text/event-json&#39;</span>
        <span class="k">try</span>
          <span class="nv">body = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>
        <span class="k">catch</span> <span class="nx">error</span>
          <span class="nx">util</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;JSON #{error} in #{body}&quot;</span>
          <span class="k">return</span>
        <span class="nv">event = </span><span class="s1">&#39;esl_event&#39;</span>
      <span class="k">when</span> <span class="s1">&#39;text/event-plain&#39;</span>
        <span class="nv">body = </span><span class="nx">parse_header_text</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>
        <span class="nv">event = </span><span class="s1">&#39;esl_event&#39;</span>
      <span class="k">when</span> <span class="s1">&#39;log/data&#39;</span>
        <span class="nv">event = </span><span class="s1">&#39;esl_log_data&#39;</span>
      <span class="k">when</span> <span class="s1">&#39;text/disconnect-notice&#39;</span>
        <span class="nv">event = </span><span class="s1">&#39;esl_disconnect_notice&#39;</span>
      <span class="k">when</span> <span class="s1">&#39;api/response&#39;</span>
        <span class="nv">event = </span><span class="s1">&#39;esl_api_response&#39;</span>
      <span class="k">else</span>
        <span class="nv">event = </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Build request and response and send them out.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">req = </span><span class="k">new</span> <span class="nx">eslRequest</span> <span class="nx">headers</span><span class="p">,</span><span class="nx">body</span>
    <span class="nv">res = </span><span class="k">new</span> <span class="nx">eslResponse</span> <span class="nx">socket</span>
    <span class="k">if</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">debug</span>
      <span class="nx">util</span><span class="p">.</span><span class="nx">log</span> <span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">event</span><span class="o">:</span><span class="nx">event</span><span class="p">,</span> <span class="nx">req</span><span class="o">:</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="o">:</span><span class="nx">res</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Get things started</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span> <span class="s1">&#39;esl_connect&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">eslResponse</span> <span class="nx">socket</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <h3>ESL Server</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">eslServer</span> <span class="k">extends</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Server</span>
  <span class="nv">constructor: </span><span class="nf">(requestListener) -&gt;</span>
    <span class="nx">@on</span> <span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="nf">(socket) -&gt;</span>
      <span class="nx">socket</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;esl_connect&#39;</span><span class="p">,</span> <span class="nx">requestListener</span>
      <span class="nx">connectionListener</span> <span class="nx">socket</span>
    <span class="k">super</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>You can use createServer(callback) from your code.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.createServer = </span><span class="nf">(requestListener) -&gt;</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">eslServer</span><span class="p">(</span><span class="nx">requestListener</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <h3>ESL client</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">eslClient</span> <span class="k">extends</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Socket</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="nx">@on</span> <span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">connectionListener</span> <span class="err">@</span>
    <span class="k">super</span><span class="p">()</span>

<span class="nv">exports.createClient = </span><span class="o">-&gt;</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">eslClient</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <h3>CallServer: a higher-level interface</h3>

<p>This interface is based on my
<a href="http://stephane.shimaore.net/git/?p=ccnq3.git;a=blob;f=applications/prepaid/">prepaid code</a>
and handles the nitty-gritty of setting up the server properly.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.createCallServer = </span><span class="o">-&gt;</span>

    <span class="nv">Unique_ID = </span><span class="s1">&#39;Unique-ID&#39;</span>

    <span class="nv">server = </span><span class="k">new</span> <span class="nx">eslServer</span> <span class="nf">(res) -&gt;</span>
      <span class="k">if</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">debug</span>
        <span class="nx">util</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Incoming connection&quot;</span>
        <span class="nx">util</span><span class="p">.</span><span class="nx">log</span> <span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">res</span>

      <span class="nx">res</span><span class="p">.</span><span class="nx">connect</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Channel data</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">channel_data = </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>UUID</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">unique_id = </span><span class="nx">channel_data</span><span class="p">[</span><span class="nx">Unique_ID</span><span class="p">]</span>

        <span class="k">if</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">debug</span>
          <span class="nx">util</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Incoming call UUID = #{unique_id}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Clean-up at the end of the connection.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">res</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;esl_disconnect_notice&#39;</span><span class="p">,</span> <span class="nf">(req,res) -&gt;</span>
          <span class="k">if</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">debug</span>
            <span class="nx">util</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Received ESL disconnection notice&quot;</span>
          <span class="k">switch</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span>
            <span class="k">when</span> <span class="s1">&#39;linger&#39;</span>      <span class="k">then</span> <span class="nx">res</span><span class="p">.</span><span class="nx">exit</span><span class="p">()</span>
            <span class="k">when</span> <span class="s1">&#39;disconnect&#39;</span>  <span class="k">then</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Use this from your code to force a disconnection.</p>

<pre><code>res.emit 'force_disconnect'
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">res</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;force_disconnect&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
          <span class="nx">util</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;Hangup call&#39;</span>
          <span class="nx">@bgapi</span> <span class="s2">&quot;uuid_kill #{unique_id}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Translate channel events into server events.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">res</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;esl_event&#39;</span><span class="p">,</span> <span class="nf">(req,res) -&gt;</span>
          <span class="nv">req.channel_data = </span><span class="nx">channel_data</span>
          <span class="nv">req.unique_id = </span><span class="nx">unique_id</span>
          <span class="nx">server</span><span class="p">.</span><span class="nx">emit</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">[</span><span class="s1">&#39;Event-Name&#39;</span><span class="p">],</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Handle the incoming connection</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">res</span><span class="p">.</span><span class="nx">linger</span> <span class="nf">(req,res) -&gt;</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">filter</span> <span class="nx">Unique_ID</span><span class="p">,</span> <span class="nx">unique_id</span><span class="p">,</span> <span class="nf">(req,res) -&gt;</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">event_json</span> <span class="s1">&#39;ALL&#39;</span><span class="p">,</span> <span class="nf">(req,res) -&gt;</span>
              <span class="nv">req.channel_data = </span><span class="nx">channel_data</span>
              <span class="nv">req.unique_id = </span><span class="nx">unique_id</span>
              <span class="nx">server</span><span class="p">.</span><span class="nx">emit</span> <span class="s1">&#39;CONNECT&#39;</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 